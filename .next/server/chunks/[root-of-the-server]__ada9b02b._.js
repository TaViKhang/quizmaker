module.exports = {

"[project]/.next-internal/server/app/api/quizzes/[id]/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/assert [external] (assert, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}}),
"[externals]/querystring [external] (querystring, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/@prisma/client/runtime/library [external] (@prisma/client/runtime/library, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@prisma/client/runtime/library", () => require("@prisma/client/runtime/library"));

module.exports = mod;
}}),
"[externals]/@prisma/client [external] (@prisma/client, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@prisma/client", () => require("@prisma/client"));

module.exports = mod;
}}),
"[project]/lib/db.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "db": (()=>db)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs)");
;
const db = globalThis.prisma || new __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["PrismaClient"]();
if ("TURBOPACK compile-time truthy", 1) globalThis.prisma = db;
}}),
"[project]/app/api/auth/[...nextauth]/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>handler),
    "POST": (()=>handler),
    "authOptions": (()=>authOptions)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$auth$2f$prisma$2d$adapter$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@auth/prisma-adapter/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/db.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$google$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/providers/google.js [app-route] (ecmascript)");
;
;
;
;
// Domain email được ủy quyền cao hơn
const AUTHORIZED_TEACHER_DOMAINS = [
    'school.edu',
    'university.edu',
    'teacher.org'
];
// Fix cho type adapter
const prismaAdapter = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$auth$2f$prisma$2d$adapter$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["PrismaAdapter"])(__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"]);
// Cải thiện error handling
const handleAuthError = (error, context)=>{
    console.error(`[Auth Error] ${context}:`, error);
    return false;
};
const authOptions = {
    adapter: prismaAdapter,
    providers: [
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$google$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
            clientId: process.env.GOOGLE_CLIENT_ID,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET,
            allowDangerousEmailAccountLinking: true
        })
    ],
    session: {
        strategy: "jwt",
        maxAge: 24 * 60 * 60,
        updateAge: 4 * 60 * 60
    },
    callbacks: {
        async jwt ({ token, user, account, profile, trigger }) {
            try {
                // Trường hợp đăng nhập - Chỉ cập nhật token khi có user từ đăng nhập
                if (user) {
                    // Đảm bảo role có thể null
                    token.role = user.role;
                    token.id = user.id;
                    return token;
                }
                // Trường hợp trigger update - Cập nhật token khi có sự thay đổi rõ ràng
                if (trigger === 'update' && token?.sub) {
                    try {
                        const dbUser = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.findUnique({
                            where: {
                                id: token.sub
                            },
                            select: {
                                id: true,
                                name: true,
                                email: true,
                                role: true,
                                image: true
                            }
                        });
                        if (dbUser) {
                            // Cập nhật token với giá trị mới
                            token.role = dbUser.role;
                            token.name = dbUser.name;
                            token.email = dbUser.email;
                            token.picture = dbUser.image;
                            // Thêm timestamp để đảm bảo không cache token cũ
                            token.updatedAt = Date.now();
                        }
                    } catch (error) {
                        console.error("Error updating token:", error);
                    }
                    return token;
                }
                // Trường hợp token từ session: kiểm tra nếu cần cập nhật
                if (token?.sub && (!token.role || !token.updatedAt || Date.now() - (token.updatedAt || 0) > 60 * 1000)) {
                    try {
                        const dbUser = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.findUnique({
                            where: {
                                id: token.sub
                            },
                            select: {
                                role: true
                            }
                        });
                        if (dbUser) {
                            token.role = dbUser.role;
                            token.updatedAt = Date.now();
                        }
                    } catch (error) {
                        console.error("Error refreshing token:", error);
                    }
                }
                return token;
            } catch (error) {
                console.error("JWT callback error:", error);
                return token;
            }
        },
        async session ({ session, token }) {
            try {
                if (session.user && token) {
                    // Đảm bảo role có thể null
                    session.user.role = token.role;
                    session.user.id = token.id;
                }
                return session;
            } catch (error) {
                console.error("Session callback error:", error);
                return session;
            }
        },
        async signIn ({ user, account, profile }) {
            // Nếu user có email
            if (user?.email) {
                try {
                    // Kiểm tra user đã tồn tại chưa
                    const existingUser = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.findUnique({
                        where: {
                            email: user.email
                        }
                    });
                    if (!existingUser) {
                        // Tạo user mới không có role (null) để người dùng chọn sau
                        await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.create({
                            data: {
                                id: user.id,
                                email: user.email,
                                name: user.name,
                                image: user.image,
                                role: null
                            }
                        });
                        // Đánh dấu để redirect tới trang chọn role
                        return true;
                    }
                    return true;
                } catch (error) {
                    return handleAuthError(error, "signIn callback");
                }
            }
            return true;
        }
    },
    pages: {
        signIn: '/auth/signin',
        signOut: '/',
        error: '/auth/error',
        newUser: '/auth/select-role' // Điều hướng người dùng mới đến trang chọn role
    },
    secret: process.env.NEXTAUTH_SECRET,
    debug: ("TURBOPACK compile-time value", "development") === "development",
    logger: {
        error (code, ...message) {
            console.error(`[NextAuth Error] ${code}:`, ...message);
        },
        warn (code, ...message) {
            if ("TURBOPACK compile-time truthy", 1) {
                console.warn(`[NextAuth Warning] ${code}:`, ...message);
            }
        },
        debug (code, ...message) {
            if ("TURBOPACK compile-time truthy", 1) {
                console.debug(`[NextAuth Debug] ${code}:`, ...message);
            }
        }
    }
};
const handler = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])(authOptions);
;
}}),
"[project]/lib/api-response.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "createAuthenticationError": (()=>createAuthenticationError),
    "createErrorResponse": (()=>createErrorResponse),
    "createNotFoundError": (()=>createNotFoundError),
    "createPaginatedResponse": (()=>createPaginatedResponse),
    "createPermissionError": (()=>createPermissionError),
    "createServerError": (()=>createServerError),
    "createSuccessResponse": (()=>createSuccessResponse),
    "createValidationError": (()=>createValidationError),
    "formatZodError": (()=>formatZodError)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
;
function createPaginatedResponse(data, total, page, limit, meta, headers) {
    const response = {
        success: true,
        data: {
            items: data,
            pagination: {
                total,
                page,
                limit,
                totalPages: Math.ceil(total / limit)
            }
        }
    };
    if (meta) {
        response.meta = meta;
    }
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(response, {
        headers
    });
}
function createSuccessResponse(data, status = 200, meta, headers) {
    const response = {
        success: true,
        data
    };
    if (meta) {
        response.meta = meta;
    }
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(response, {
        status,
        headers
    });
}
function createErrorResponse(code, message, details, status = 400) {
    const response = {
        success: false,
        error: {
            code,
            message
        }
    };
    if (details) {
        response.error.details = details;
    }
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(response, {
        status
    });
}
function formatZodError(error) {
    return {
        code: "VALIDATION_ERROR",
        message: "Invalid input data",
        details: error.errors.map((err)=>({
                path: err.path.join('.'),
                message: err.message
            }))
    };
}
function createAuthenticationError() {
    return createErrorResponse("UNAUTHENTICATED", "You must be logged in to access this resource", undefined, 401);
}
function createPermissionError(message = "You don't have permission to access this resource") {
    return createErrorResponse("UNAUTHORIZED", message, undefined, 403);
}
function createNotFoundError(resource = "Resource") {
    return createErrorResponse("NOT_FOUND", `${resource} not found`, undefined, 404);
}
function createServerError(error) {
    console.error("Server error:", error);
    return createErrorResponse("SERVER_ERROR", "An unexpected error occurred", ("TURBOPACK compile-time truthy", 1) ? error?.message : ("TURBOPACK unreachable", undefined), 500);
}
function createValidationError(details) {
    return createErrorResponse("VALIDATION_ERROR", "Invalid input data", details, 400);
}
}}),
"[project]/lib/notification-service.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "createNotification": (()=>createNotification),
    "createNotificationsForClass": (()=>createNotificationsForClass),
    "createQuizReminders": (()=>createQuizReminders),
    "deleteExpiredNotifications": (()=>deleteExpiredNotifications),
    "markNotificationsAsRead": (()=>markNotificationsAsRead)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/db.ts [app-route] (ecmascript)");
;
async function createNotification({ userId, title, message, category, resourceId, resourceType, expiredAt }) {
    return __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].notification.create({
        data: {
            userId,
            title,
            message,
            category: category,
            resourceId,
            resourceType,
            expiredAt
        }
    });
}
async function createNotificationsForClass({ classId, title, message, category, resourceId, resourceType, expiredAt, excludeUserIds = [] }) {
    // Get all students in the class
    const enrollments = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].classEnrollment.findMany({
        where: {
            classId,
            studentId: {
                notIn: excludeUserIds
            }
        },
        select: {
            studentId: true
        }
    });
    // Create notifications for all students
    if (enrollments.length > 0) {
        await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].notification.createMany({
            data: enrollments.map((enrollment)=>({
                    userId: enrollment.studentId,
                    title,
                    message,
                    category: category,
                    resourceId,
                    resourceType,
                    expiredAt
                }))
        });
    }
    return enrollments.length;
}
async function markNotificationsAsRead(userId, notificationIds) {
    if (notificationIds && notificationIds.length > 0) {
        // Mark specific notifications as read
        return __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].notification.updateMany({
            where: {
                id: {
                    in: notificationIds
                },
                userId
            },
            data: {
                isRead: true
            }
        });
    } else {
        // Mark all notifications as read
        return __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].notification.updateMany({
            where: {
                userId,
                isRead: false
            },
            data: {
                isRead: true
            }
        });
    }
}
async function deleteExpiredNotifications() {
    const now = new Date();
    return __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].notification.deleteMany({
        where: {
            expiredAt: {
                lt: now
            }
        }
    });
}
async function createQuizReminders() {
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    // Find quizzes ending within the next 24 hours
    const upcomingQuizzes = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].quiz.findMany({
        where: {
            endDate: {
                gte: now,
                lte: tomorrow
            },
            isActive: true,
            isPublished: true
        },
        include: {
            class: {
                select: {
                    id: true,
                    name: true
                }
            }
        }
    });
    // Create reminder notifications
    for (const quiz of upcomingQuizzes){
        if (quiz.classId) {
            await createNotificationsForClass({
                classId: quiz.classId,
                title: "Quiz Reminder",
                message: `The quiz "${quiz.title}" in class "${quiz.class?.name}" will end on ${quiz.endDate.toLocaleString()}`,
                category: 'QUIZ_REMINDER',
                resourceId: quiz.id,
                resourceType: "quiz",
                expiredAt: quiz.endDate
            });
        }
    }
    return upcomingQuizzes.length;
}
}}),
"[project]/app/api/quizzes/[id]/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>GET),
    "PUT": (()=>PUT)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$api$2f$auth$2f5b2e2e2e$nextauth$5d2f$route$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/app/api/auth/[...nextauth]/route.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/db.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/zod/lib/index.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/api-response.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$notification$2d$service$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/notification-service.ts [app-route] (ecmascript)");
;
;
;
;
;
;
;
// Schema validation for updating a quiz
const updateQuizSchema = __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].object({
    title: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].string().min(1, "Quiz title is required").max(200, "Quiz title too long").optional(),
    description: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].string().max(2000, "Description too long").optional().nullable(),
    timeLimit: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].number().int().min(1, "Time limit must be at least 1 minute").optional(),
    maxAttempts: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].number().int().positive().optional().nullable(),
    passingScore: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].number().min(0).max(100, "Passing score must be between 0-100").optional().nullable(),
    shuffleQuestions: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].boolean().optional(),
    showResults: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].boolean().optional(),
    startDate: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].string().datetime().optional().nullable(),
    endDate: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].string().datetime().optional().nullable(),
    isActive: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].boolean().optional(),
    isPublished: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].boolean().optional(),
    accessCode: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].string().max(20, "Access code too long").optional().nullable(),
    category: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].string().max(50, "Category too long").optional().nullable(),
    tags: __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].array(__TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$zod$2f$lib$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["z"].string()).optional()
});
async function GET(request, { params }) {
    try {
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])(__TURBOPACK__imported__module__$5b$project$5d2f$app$2f$api$2f$auth$2f5b2e2e2e$nextauth$5d2f$route$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authOptions"]);
        if (!session?.user) {
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createAuthenticationError"])();
        }
        const quizId = params.id;
        const isTeacher = session.user.role === __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["Role"].TEACHER;
        // Find quiz with different data based on user role
        if (isTeacher) {
            // Teacher view - include all information including questions and answers
            const quiz = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].quiz.findUnique({
                where: {
                    id: quizId
                },
                include: {
                    author: {
                        select: {
                            id: true,
                            name: true,
                            image: true
                        }
                    },
                    class: {
                        select: {
                            id: true,
                            name: true,
                            code: true,
                            teacherId: true,
                            teacher: {
                                select: {
                                    id: true,
                                    name: true,
                                    image: true
                                }
                            }
                        }
                    },
                    questions: {
                        orderBy: {
                            order: 'asc'
                        },
                        include: {
                            options: {
                                orderBy: {
                                    order: 'asc'
                                }
                            }
                        }
                    },
                    _count: {
                        select: {
                            questions: true,
                            attempts: true
                        }
                    }
                }
            });
            if (!quiz) {
                return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createNotFoundError"])("Quiz not found");
            }
            // Check if the teacher has permission to view this quiz
            const isAuthor = quiz.authorId === session.user.id;
            const isClassTeacher = quiz.class?.teacherId === session.user.id;
            if (!isAuthor && !isClassTeacher) {
                return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createPermissionError"])("You don't have permission to view this quiz");
            }
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createSuccessResponse"])(quiz);
        } else {
            // Student view - don't include correct answers if student hasn't completed the quiz
            // First check if the quiz is available to the student
            const quizBasicInfo = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].quiz.findUnique({
                where: {
                    id: quizId,
                    isPublished: true,
                    isActive: true
                },
                include: {
                    class: {
                        select: {
                            id: true,
                            name: true,
                            type: true,
                            students: {
                                where: {
                                    studentId: session.user.id
                                },
                                select: {
                                    id: true
                                }
                            }
                        }
                    }
                }
            });
            if (!quizBasicInfo) {
                return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createNotFoundError"])("Quiz not found or not available");
            }
            // Check if student is enrolled in the class (if quiz is attached to a class)
            if (quizBasicInfo.classId) {
                const isEnrolled = quizBasicInfo.class?.students && quizBasicInfo.class.students.length > 0;
                const isPublicClass = quizBasicInfo.class?.type === "PUBLIC";
                if (!isEnrolled && !isPublicClass) {
                    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createPermissionError"])("You don't have access to this quiz");
                }
            }
            // Check if quiz is within the available time frame
            const now = new Date();
            if (quizBasicInfo.startDate && new Date(quizBasicInfo.startDate) > now || quizBasicInfo.endDate && new Date(quizBasicInfo.endDate) < now) {
                return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createErrorResponse"])("QUIZ_NOT_AVAILABLE", "This quiz is not available at this time");
            }
            // Check if student has remaining attempts
            if (quizBasicInfo.maxAttempts) {
                const attemptCount = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].quizAttempt.count({
                    where: {
                        quizId,
                        userId: session.user.id
                    }
                });
                if (attemptCount >= quizBasicInfo.maxAttempts) {
                    return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createErrorResponse"])("MAX_ATTEMPTS_REACHED", "You have reached the maximum number of attempts for this quiz");
                }
            }
            // Fetch quiz details for student (excluding correct answers)
            const quiz = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].quiz.findUnique({
                where: {
                    id: quizId
                },
                include: {
                    author: {
                        select: {
                            id: true,
                            name: true,
                            image: true
                        }
                    },
                    class: {
                        select: {
                            id: true,
                            name: true
                        }
                    },
                    questions: {
                        orderBy: {
                            order: 'asc'
                        },
                        select: {
                            id: true,
                            content: true,
                            type: true,
                            points: true,
                            order: true,
                            mediaUrl: true,
                            mediaType: true,
                            metadata: true,
                            category: true,
                            options: quizBasicInfo.shuffleQuestions ? undefined : {
                                select: {
                                    id: true,
                                    content: true,
                                    order: true,
                                    matchId: true,
                                    group: true,
                                    position: true
                                },
                                orderBy: {
                                    order: 'asc'
                                }
                            }
                        }
                    },
                    _count: {
                        select: {
                            questions: true
                        }
                    },
                    attempts: {
                        where: {
                            userId: session.user.id
                        },
                        orderBy: {
                            startedAt: 'desc'
                        },
                        select: {
                            id: true,
                            startedAt: true,
                            completedAt: true,
                            score: true,
                            timeSpent: true
                        },
                        take: 5 // Only return the most recent 5 attempts
                    }
                }
            });
            if (!quiz) {
                return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createNotFoundError"])("Quiz not found");
            }
            // Chuẩn bị kết quả cuối cùng để trả về
            let finalResult = {
                ...quiz
            };
            // If quiz specifies to shuffle questions, randomize the order for the student
            if (quizBasicInfo.shuffleQuestions && quiz.questions) {
                // Make a deep copy to avoid mutation issues
                const shuffledQuestions = [
                    ...quiz.questions
                ].sort(()=>Math.random() - 0.5);
                // For each question, fetch and shuffle options separately
                const questionsWithOptions = await Promise.all(shuffledQuestions.map(async (question)=>{
                    const questionId = question.id;
                    const options = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].option.findMany({
                        where: {
                            questionId
                        },
                        select: {
                            id: true,
                            content: true,
                            order: true,
                            matchId: true,
                            group: true,
                            position: true
                        }
                    });
                    // Shuffle options (except for certain question types where order matters)
                    if (question.type !== __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["QuestionType"].FILL_BLANK && question.type !== __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["QuestionType"].MATCHING) {
                        return {
                            ...question,
                            options: [
                                ...options
                            ].sort(()=>Math.random() - 0.5)
                        };
                    } else {
                        return {
                            ...question,
                            options
                        };
                    }
                }));
                // Create a new object with shuffled questions instead of modifying finalResult
                finalResult = {
                    ...finalResult,
                    questions: questionsWithOptions
                };
            }
            // Add attempt information
            const attemptCount = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].quizAttempt.count({
                where: {
                    quizId,
                    userId: session.user.id
                }
            });
            // Add additional properties to our response
            const enrichedQuizData = {
                ...finalResult,
                userAttemptCount: attemptCount,
                attemptsRemaining: finalResult.maxAttempts ? Math.max(0, finalResult.maxAttempts - attemptCount) : null
            };
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createSuccessResponse"])(enrichedQuizData);
        }
    } catch (error) {
        console.error("Error fetching quiz:", error);
        return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerError"])(error instanceof Error ? error : new Error("Unknown error"));
    }
}
async function PUT(request, { params }) {
    try {
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])(__TURBOPACK__imported__module__$5b$project$5d2f$app$2f$api$2f$auth$2f5b2e2e2e$nextauth$5d2f$route$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authOptions"]);
        if (!session?.user) {
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createAuthenticationError"])();
        }
        // Only teachers can update quizzes
        if (session.user.role !== __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["Role"].TEACHER) {
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createPermissionError"])("Only teachers can update quizzes");
        }
        const quizId = params.id;
        // Check if quiz exists and teacher has permission to update it
        const existingQuiz = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].quiz.findUnique({
            where: {
                id: quizId
            },
            include: {
                attempts: {
                    select: {
                        id: true
                    },
                    take: 1
                }
            }
        });
        if (!existingQuiz) {
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createNotFoundError"])("Quiz not found");
        }
        // Only the author can update the quiz
        if (existingQuiz.authorId !== session.user.id) {
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createPermissionError"])("You don't have permission to update this quiz");
        }
        const body = await request.json();
        const validationResult = updateQuizSchema.safeParse(body);
        if (!validationResult.success) {
            return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createErrorResponse"])("VALIDATION_ERROR", "Invalid quiz data", (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["formatZodError"])(validationResult.error));
        }
        const data = validationResult.data;
        // Validate dates if provided
        if (data.startDate && data.endDate) {
            const startDate = new Date(data.startDate);
            const endDate = new Date(data.endDate);
            if (startDate > endDate) {
                return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createErrorResponse"])("VALIDATION_ERROR", "Start date must be before end date", {
                    startDate: "Start date must be before end date"
                });
            }
        }
        // Check if quiz has attempts - restrict changes if it does
        const hasAttempts = existingQuiz.attempts.length > 0;
        if (hasAttempts) {
            // Only restrict certain fields, but allow updating time-related fields
            const restrictedFields = [
                'shuffleQuestions'
            ];
            for (const field of restrictedFields){
                // Safe type checking using type assertion and explicit checks
                const fieldName = field;
                if (fieldName in data && data[fieldName] !== undefined) {
                    const quizField = field;
                    if (data[fieldName] !== existingQuiz[quizField]) {
                        return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createErrorResponse"])("CANNOT_MODIFY", `Cannot modify ${field} for quizzes that have been attempted`, {
                            [field]: `Cannot modify ${field} for quizzes that have been attempted`
                        });
                    }
                }
            }
        }
        // Parse dates for database
        const parsedData = {
            ...data,
            startDate: data.startDate !== undefined ? data.startDate === null ? null : new Date(data.startDate) : undefined,
            endDate: data.endDate !== undefined ? data.endDate === null ? null : new Date(data.endDate) : undefined
        };
        // Update quiz
        const updatedQuiz = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].quiz.update({
            where: {
                id: quizId
            },
            data: parsedData,
            select: {
                id: true,
                title: true,
                description: true,
                classId: true,
                timeLimit: true,
                maxAttempts: true,
                passingScore: true,
                shuffleQuestions: true,
                showResults: true,
                startDate: true,
                endDate: true,
                isActive: true,
                isPublished: true,
                accessCode: true,
                category: true,
                tags: true,
                updatedAt: true
            }
        });
        // Create notifications if the quiz is published or its publish state changed
        if (data.isPublished === true && !existingQuiz.isPublished && existingQuiz.classId) {
            const classDetails = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].class.findUnique({
                where: {
                    id: existingQuiz.classId
                },
                select: {
                    name: true
                }
            });
            if (classDetails) {
                await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$notification$2d$service$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createNotificationsForClass"])({
                    classId: existingQuiz.classId,
                    title: "New Quiz Available",
                    message: `A new quiz "${updatedQuiz.title}" is available in class "${classDetails.name}"`,
                    category: 'NEW_QUIZ',
                    resourceId: updatedQuiz.id,
                    resourceType: "quiz",
                    expiredAt: updatedQuiz.endDate ? new Date(updatedQuiz.endDate) : undefined
                });
            }
        }
        // If significant details changed, notify students
        if (existingQuiz.isPublished && data.isPublished !== false && existingQuiz.classId && (data.title || data.startDate || data.endDate || data.timeLimit)) {
            const classDetails = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].class.findUnique({
                where: {
                    id: existingQuiz.classId
                },
                select: {
                    name: true
                }
            });
            if (classDetails) {
                let changeMessage = "The following details have been updated: ";
                const changes = [];
                if (data.title && data.title !== existingQuiz.title) changes.push("title");
                if (data.startDate && existingQuiz.startDate?.toISOString() !== new Date(data.startDate).toISOString()) changes.push("start date");
                if (data.endDate && existingQuiz.endDate?.toISOString() !== new Date(data.endDate).toISOString()) changes.push("end date");
                if (data.timeLimit && data.timeLimit !== existingQuiz.timeLimit) changes.push("time limit");
                changeMessage += changes.join(", ");
                // Create notification with properly typed dates
                await (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$notification$2d$service$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createNotificationsForClass"])({
                    classId: existingQuiz.classId,
                    title: "Quiz Updated",
                    message: `Quiz "${updatedQuiz.title}" in class "${classDetails.name}" has been updated. ${changeMessage}`,
                    category: 'NEW_QUIZ',
                    resourceId: updatedQuiz.id,
                    resourceType: "quiz",
                    expiredAt: data.endDate ? new Date(data.endDate) : undefined
                });
                // If the quiz was updated to have a start date in the future, set a reminder
                if (data.startDate && new Date(data.startDate) > new Date()) {
                    const reminderTime = new Date(data.startDate);
                    reminderTime.setHours(reminderTime.getHours() - 24); // 24 hours before
                    if (reminderTime > new Date()) {
                        // Schedule a reminder notification - but API doesn't support scheduled notifications so just create a reminder notification
                        await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].notification.create({
                            data: {
                                userId: existingQuiz.authorId,
                                category: __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["NotificationType"].QUIZ_REMINDER,
                                title: 'Quiz Reminder',
                                message: `Don't forget to check your quiz "${updatedQuiz.title}"`,
                                resourceId: updatedQuiz.id,
                                resourceType: "quiz"
                            }
                        });
                    }
                }
            }
        }
        return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createSuccessResponse"])(updatedQuiz);
    } catch (error) {
        console.error("Error updating quiz:", error);
        return (0, __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$api$2d$response$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createServerError"])(error instanceof Error ? error : new Error("Unknown error"));
    }
}
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__ada9b02b._.js.map
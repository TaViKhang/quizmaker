module.exports = {

"[project]/.next-internal/server/app/api/users/me/score-analytics/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/assert [external] (assert, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}}),
"[externals]/querystring [external] (querystring, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/@prisma/client/runtime/library [external] (@prisma/client/runtime/library, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@prisma/client/runtime/library", () => require("@prisma/client/runtime/library"));

module.exports = mod;
}}),
"[externals]/@prisma/client [external] (@prisma/client, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@prisma/client", () => require("@prisma/client"));

module.exports = mod;
}}),
"[project]/lib/db.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "db": (()=>db)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs)");
;
const db = globalThis.prisma || new __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["PrismaClient"]();
if ("TURBOPACK compile-time truthy", 1) globalThis.prisma = db;
}}),
"[project]/app/api/auth/[...nextauth]/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>handler),
    "POST": (()=>handler),
    "authOptions": (()=>authOptions)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$auth$2f$prisma$2d$adapter$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@auth/prisma-adapter/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/db.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$google$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/providers/google.js [app-route] (ecmascript)");
;
;
;
;
// Domain email được ủy quyền cao hơn
const AUTHORIZED_TEACHER_DOMAINS = [
    'school.edu',
    'university.edu',
    'teacher.org'
];
// Fix cho type adapter
const prismaAdapter = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$auth$2f$prisma$2d$adapter$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["PrismaAdapter"])(__TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"]);
// Cải thiện error handling
const handleAuthError = (error, context)=>{
    console.error(`[Auth Error] ${context}:`, error);
    return false;
};
const authOptions = {
    adapter: prismaAdapter,
    providers: [
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$google$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
            clientId: process.env.GOOGLE_CLIENT_ID,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET,
            allowDangerousEmailAccountLinking: true
        })
    ],
    session: {
        strategy: "jwt",
        maxAge: 24 * 60 * 60,
        updateAge: 4 * 60 * 60
    },
    callbacks: {
        async jwt ({ token, user, account, profile, trigger }) {
            try {
                // Trường hợp đăng nhập - Chỉ cập nhật token khi có user từ đăng nhập
                if (user) {
                    // Đảm bảo role có thể null
                    token.role = user.role;
                    token.id = user.id;
                    return token;
                }
                // Trường hợp trigger update - Cập nhật token khi có sự thay đổi rõ ràng
                if (trigger === 'update' && token?.sub) {
                    try {
                        const dbUser = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.findUnique({
                            where: {
                                id: token.sub
                            },
                            select: {
                                id: true,
                                name: true,
                                email: true,
                                role: true,
                                image: true
                            }
                        });
                        if (dbUser) {
                            // Cập nhật token với giá trị mới
                            token.role = dbUser.role;
                            token.name = dbUser.name;
                            token.email = dbUser.email;
                            token.picture = dbUser.image;
                            // Thêm timestamp để đảm bảo không cache token cũ
                            token.updatedAt = Date.now();
                        }
                    } catch (error) {
                        console.error("Error updating token:", error);
                    }
                    return token;
                }
                // Trường hợp token từ session: kiểm tra nếu cần cập nhật
                if (token?.sub && (!token.role || !token.updatedAt || Date.now() - (token.updatedAt || 0) > 60 * 1000)) {
                    try {
                        const dbUser = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.findUnique({
                            where: {
                                id: token.sub
                            },
                            select: {
                                role: true
                            }
                        });
                        if (dbUser) {
                            token.role = dbUser.role;
                            token.updatedAt = Date.now();
                        }
                    } catch (error) {
                        console.error("Error refreshing token:", error);
                    }
                }
                return token;
            } catch (error) {
                console.error("JWT callback error:", error);
                return token;
            }
        },
        async session ({ session, token }) {
            try {
                if (session.user && token) {
                    // Đảm bảo role có thể null
                    session.user.role = token.role;
                    session.user.id = token.id;
                }
                return session;
            } catch (error) {
                console.error("Session callback error:", error);
                return session;
            }
        },
        async signIn ({ user, account, profile }) {
            // Nếu user có email
            if (user?.email) {
                try {
                    // Kiểm tra user đã tồn tại chưa
                    const existingUser = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.findUnique({
                        where: {
                            email: user.email
                        }
                    });
                    if (!existingUser) {
                        // Tạo user mới không có role (null) để người dùng chọn sau
                        await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.create({
                            data: {
                                id: user.id,
                                email: user.email,
                                name: user.name,
                                image: user.image,
                                role: null
                            }
                        });
                        // Đánh dấu để redirect tới trang chọn role
                        return true;
                    }
                    return true;
                } catch (error) {
                    return handleAuthError(error, "signIn callback");
                }
            }
            return true;
        }
    },
    pages: {
        signIn: '/auth/signin',
        signOut: '/',
        error: '/auth/error',
        newUser: '/auth/select-role' // Điều hướng người dùng mới đến trang chọn role
    },
    secret: process.env.NEXTAUTH_SECRET,
    debug: ("TURBOPACK compile-time value", "development") === "development",
    logger: {
        error (code, ...message) {
            console.error(`[NextAuth Error] ${code}:`, ...message);
        },
        warn (code, ...message) {
            if ("TURBOPACK compile-time truthy", 1) {
                console.warn(`[NextAuth Warning] ${code}:`, ...message);
            }
        },
        debug (code, ...message) {
            if ("TURBOPACK compile-time truthy", 1) {
                console.debug(`[NextAuth Debug] ${code}:`, ...message);
            }
        }
    }
};
const handler = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])(authOptions);
;
}}),
"[project]/lib/prisma.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "prisma": (()=>prisma)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/db.ts [app-route] (ecmascript)");
;
const prisma = __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"];
}}),
"[project]/app/api/users/me/score-analytics/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "GET": (()=>GET),
    "dynamic": (()=>dynamic),
    "revalidate": (()=>revalidate)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$next$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/next/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$app$2f$api$2f$auth$2f5b2e2e2e$nextauth$5d2f$route$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/app/api/auth/[...nextauth]/route.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$prisma$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/lib/prisma.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/date-fns/format.mjs [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subMonths$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/subMonths.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/subDays.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfMonth$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/startOfMonth.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$endOfMonth$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/endOfMonth.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfWeek$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/startOfWeek.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$addDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/addDays.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$isBefore$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns/isBefore.mjs [app-route] (ecmascript)");
;
;
;
;
;
/**
 * Utility function to create consistent API responses
 */ function createApiResponse(data, options = {}) {
    return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
        success: true,
        data
    }, {
        headers: options.headers || {}
    });
}
const dynamic = 'force-dynamic'; // Opt out of static rendering
const revalidate = 3600; // Revalidate every hour
async function GET(req) {
    try {
        // Parse request URL for query parameters
        const { searchParams } = new URL(req.url);
        const queryParams = {
            timeFrame: searchParams.get('timeFrame') || 'last30days',
            subject: searchParams.get('subject') || undefined,
            minScore: searchParams.get('minScore') || undefined,
            maxScore: searchParams.get('maxScore') || undefined,
            includePublicQuizzes: searchParams.get('includePublicQuizzes') === 'true'
        };
        // Get the current session to identify the user
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$next$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])(__TURBOPACK__imported__module__$5b$project$5d2f$app$2f$api$2f$auth$2f5b2e2e2e$nextauth$5d2f$route$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authOptions"]);
        if (!session?.user?.id) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Authentication required"
            }, {
                status: 401
            });
        }
        const userId = session.user.id;
        // Check if the user has the student role
        const user = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$prisma$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["prisma"].user.findUnique({
            where: {
                id: userId
            },
            select: {
                role: true
            }
        });
        if (user?.role !== "STUDENT") {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Only students can access this endpoint"
            }, {
                status: 403
            });
        }
        // Get date ranges for current and previous periods based on timeFrame
        const { currentStartDate, currentEndDate, previousStartDate, previousEndDate, currentPeriodLabel, previousPeriodLabel } = getDateRanges(queryParams.timeFrame);
        // Calculate the appropriate time grouping based on the timeFrame
        const timeGrouping = getTimeGrouping(queryParams.timeFrame);
        // Build filters
        const currentPeriodFilter = {
            userId,
            completedAt: {
                not: null,
                gte: currentStartDate,
                lte: currentEndDate
            }
        };
        const previousPeriodFilter = {
            userId,
            completedAt: {
                not: null,
                gte: previousStartDate,
                lte: previousEndDate
            }
        };
        // Add score filter if provided
        let scoreFilter = {};
        if (queryParams.minScore || queryParams.maxScore) {
            scoreFilter = {
                score: {
                    ...queryParams.minScore && {
                        gte: parseFloat(queryParams.minScore)
                    },
                    ...queryParams.maxScore && {
                        lte: parseFloat(queryParams.maxScore)
                    }
                }
            };
        }
        // Build category filter if provided
        let categoryFilter = {};
        if (queryParams.subject) {
            categoryFilter = {
                quiz: {
                    category: {
                        equals: queryParams.subject
                    }
                }
            };
        }
        // Combine all filters
        const currentPeriodWhereClause = {
            ...currentPeriodFilter,
            ...scoreFilter,
            ...categoryFilter
        };
        const previousPeriodWhereClause = {
            ...previousPeriodFilter,
            ...scoreFilter,
            ...categoryFilter
        };
        // 1. Fetch ALL completed attempts within current period for accurate analytics
        // (not limited by pagination, we need all data for proper calculations)
        const currentPeriodAttempts = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$prisma$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["prisma"].quizAttempt.findMany({
            where: currentPeriodWhereClause,
            include: {
                quiz: {
                    select: {
                        title: true,
                        category: true,
                        isPublic: true
                    }
                }
            },
            orderBy: {
                completedAt: 'desc'
            }
        });
        // Filter attempts based on quiz visibility setting (include or exclude public quizzes)
        const filteredAttempts = queryParams.includePublicQuizzes ? currentPeriodAttempts : currentPeriodAttempts.filter((attempt)=>!attempt.quiz?.isPublic);
        // Debug logging for development
        if ("TURBOPACK compile-time truthy", 1) {
            console.log(`[Score Analytics API] User: ${userId}`);
            console.log(`[Score Analytics API] Time frame: ${queryParams.timeFrame}`);
            console.log(`[Score Analytics API] Include public quizzes: ${queryParams.includePublicQuizzes}`);
            console.log(`[Score Analytics API] Total attempts found: ${currentPeriodAttempts.length}`);
            console.log(`[Score Analytics API] Filtered attempts: ${filteredAttempts.length}`);
            console.log(`[Score Analytics API] Public quiz attempts filtered out: ${currentPeriodAttempts.length - filteredAttempts.length}`);
        }
        if (!filteredAttempts.length) {
            console.log(`[Score Analytics API] No data found for user ${userId} in timeframe ${queryParams.timeFrame}`);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: true,
                data: {
                    overallStats: {
                        averageScore: 0,
                        previousAverageScore: null,
                        improvement: null,
                        totalAssessments: 0,
                        currentPeriodLabel,
                        previousPeriodLabel
                    },
                    timeSeriesData: [],
                    subjectPerformance: []
                }
            }, {
                headers: {
                    'Cache-Control': 'max-age=3600, s-maxage=3600'
                }
            });
        }
        // 2. Calculate overall stats
        const overallStats = await calculateOverallStats(userId, currentStartDate, currentEndDate, previousStartDate, previousEndDate, currentPeriodLabel, previousPeriodLabel, currentPeriodWhereClause, previousPeriodWhereClause);
        // 3. Generate time series data
        const timeSeriesData = generateTimeSeriesData(filteredAttempts, timeGrouping, currentStartDate, currentEndDate);
        // 4. Calculate subject performance
        const subjectPerformance = calculateSubjectPerformance(filteredAttempts);
        // 5. Combine all data into the final response
        const analyticsData = {
            overallStats,
            timeSeriesData,
            subjectPerformance
        };
        // Debug logging for successful response
        if ("TURBOPACK compile-time truthy", 1) {
            console.log(`[Score Analytics API] Successful response for user ${userId}:`);
            console.log(`[Score Analytics API] - Average score: ${overallStats.averageScore}`);
            console.log(`[Score Analytics API] - Total assessments: ${overallStats.totalAssessments}`);
            console.log(`[Score Analytics API] - Time series data points: ${timeSeriesData.length}`);
            console.log(`[Score Analytics API] - Subject performance entries: ${subjectPerformance.length}`);
        }
        // Return the data with appropriate cache headers
        return createApiResponse(analyticsData, {
            headers: {
                'Cache-Control': 'max-age=3600, s-maxage=3600'
            }
        });
    } catch (err) {
        console.error("Error fetching score analytics:", err);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: false,
            error: "Failed to fetch score analytics data"
        }, {
            status: 500
        });
    }
}
/**
 * Calculate overall statistics for both current and previous periods
 * Uses best attempt per quiz to avoid inflated counts from practice attempts
 */ async function calculateOverallStats(userId, currentStartDate, currentEndDate, previousStartDate, previousEndDate, currentPeriodLabel, previousPeriodLabel, currentPeriodWhereClause, previousPeriodWhereClause) {
    // Get current period attempts with quiz info
    const currentPeriodAttempts = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$prisma$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["prisma"].quizAttempt.findMany({
        where: currentPeriodWhereClause,
        select: {
            score: true,
            quizId: true
        }
    });
    // Group by quiz and get best score for each unique quiz
    const quizBestScores = new Map();
    currentPeriodAttempts.forEach((attempt)=>{
        if (attempt.score !== null) {
            const currentBest = quizBestScores.get(attempt.quizId) || 0;
            if (attempt.score > currentBest) {
                quizBestScores.set(attempt.quizId, attempt.score);
            }
        }
    });
    const currentPeriodScores = Array.from(quizBestScores.values());
    const averageScore = currentPeriodScores.length > 0 ? currentPeriodScores.reduce((sum, score)=>sum + score, 0) / currentPeriodScores.length : 0;
    // Count unique quizzes, not total attempts
    const totalAssessments = quizBestScores.size;
    // Get previous period stats (if applicable)
    let previousAverageScore = null;
    let improvement = null;
    if (previousStartDate && previousEndDate) {
        const previousPeriodAttempts = await __TURBOPACK__imported__module__$5b$project$5d2f$lib$2f$prisma$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["prisma"].quizAttempt.findMany({
            where: previousPeriodWhereClause,
            select: {
                score: true,
                quizId: true
            }
        });
        // Group by quiz and get best score for each unique quiz in previous period
        const previousQuizBestScores = new Map();
        previousPeriodAttempts.forEach((attempt)=>{
            if (attempt.score !== null) {
                const currentBest = previousQuizBestScores.get(attempt.quizId) || 0;
                if (attempt.score > currentBest) {
                    previousQuizBestScores.set(attempt.quizId, attempt.score);
                }
            }
        });
        const previousPeriodScores = Array.from(previousQuizBestScores.values());
        previousAverageScore = previousPeriodScores.length > 0 ? previousPeriodScores.reduce((sum, score)=>sum + score, 0) / previousPeriodScores.length : null;
        // Calculate improvement percentage if we have both scores
        if (previousAverageScore !== null && previousAverageScore > 0) {
            improvement = (averageScore - previousAverageScore) / previousAverageScore * 100;
        }
    }
    return {
        averageScore,
        previousAverageScore,
        improvement,
        totalAssessments,
        currentPeriodLabel,
        previousPeriodLabel
    };
}
/**
 * Generate time series data with appropriate granularity based on selected timeFrame
 * Uses best attempt per quiz per time period to avoid inflated counts
 */ function generateTimeSeriesData(attempts, grouping, startDate, endDate) {
    // Group attempts by the specified time unit and quiz
    const groupedAttempts = new Map();
    // Generate all time points in the range (even with no data)
    const allTimePoints = [];
    let currentDate = new Date(startDate);
    while((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$isBefore$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["isBefore"])(currentDate, endDate) || (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(currentDate, 'yyyy-MM-dd') === (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(endDate, 'yyyy-MM-dd')){
        let timePoint;
        if (grouping === 'day') {
            timePoint = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(currentDate, 'yyyy-MM-dd');
            currentDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$addDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addDays"])(currentDate, 1);
        } else if (grouping === 'week') {
            const weekStart = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfWeek$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["startOfWeek"])(currentDate, {
                weekStartsOn: 1
            }); // Monday as week start
            timePoint = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(weekStart, 'yyyy-MM-dd');
            currentDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$addDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addDays"])(currentDate, 7);
        } else {
            const monthStart = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfMonth$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["startOfMonth"])(currentDate);
            timePoint = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(monthStart, 'yyyy-MM');
            currentDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$addDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["addDays"])((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$endOfMonth$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["endOfMonth"])(currentDate), 1);
        }
        if (!groupedAttempts.has(timePoint)) {
            groupedAttempts.set(timePoint, new Map());
        }
        allTimePoints.push(timePoint);
    }
    // Process attempts into the grouped structure, tracking best score per quiz per time period
    for (const attempt of attempts){
        if (!attempt.completedAt || !attempt.score) continue;
        const attemptDate = new Date(attempt.completedAt);
        let timePoint;
        if (grouping === 'day') {
            timePoint = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(attemptDate, 'yyyy-MM-dd');
        } else if (grouping === 'week') {
            const weekStart = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$startOfWeek$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["startOfWeek"])(attemptDate, {
                weekStartsOn: 1
            }); // Monday as week start
            timePoint = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(weekStart, 'yyyy-MM-dd');
        } else {
            timePoint = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$format$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["format"])(attemptDate, 'yyyy-MM');
        }
        if (!groupedAttempts.has(timePoint)) {
            groupedAttempts.set(timePoint, new Map());
        }
        const timeGroup = groupedAttempts.get(timePoint);
        const quizId = attempt.quizId;
        if (!timeGroup.has(quizId)) {
            timeGroup.set(quizId, {
                bestScore: attempt.score,
                hasAttempt: true
            });
        } else {
            const existing = timeGroup.get(quizId);
            if (attempt.score > existing.bestScore) {
                existing.bestScore = attempt.score;
            }
        }
    }
    // Convert the grouped data to the expected output format
    const result = allTimePoints.filter((timePoint, index, self)=>self.indexOf(timePoint) === index) // Remove duplicates
    .map((timePoint)=>{
        const timeGroup = groupedAttempts.get(timePoint);
        const quizScores = Array.from(timeGroup.values()).map((quiz)=>quiz.bestScore);
        const averageScore = quizScores.length > 0 ? quizScores.reduce((sum, score)=>sum + score, 0) / quizScores.length : 0;
        return {
            date: timePoint,
            averageScore,
            assessmentCount: quizScores.length
        };
    }).sort((a, b)=>a.date.localeCompare(b.date)); // Ensure chronological order
    return result;
}
/**
 * Calculate performance metrics by subject (category)
 * Uses best attempt per quiz to avoid inflated counts from practice attempts
 */ function calculateSubjectPerformance(attempts) {
    // Group attempts by subject and quiz, tracking best score per quiz
    const subjectMap = new Map();
    for (const attempt of attempts){
        if (!attempt.score) continue;
        const subject = attempt.quiz?.category || "Unknown";
        const quizId = attempt.quizId;
        if (!subjectMap.has(subject)) {
            subjectMap.set(subject, new Map());
        }
        const subjectQuizzes = subjectMap.get(subject);
        if (!subjectQuizzes.has(quizId)) {
            subjectQuizzes.set(quizId, attempt.score);
        } else {
            const currentBest = subjectQuizzes.get(quizId);
            if (attempt.score > currentBest) {
                subjectQuizzes.set(quizId, attempt.score);
            }
        }
    }
    // Convert the grouped data to the expected output format
    const result = Array.from(subjectMap.entries()).map(([subject, quizScores])=>{
        const scores = Array.from(quizScores.values());
        const averageScore = scores.length > 0 ? scores.reduce((sum, score)=>sum + score, 0) / scores.length : 0;
        return {
            subject,
            averageScore,
            assessmentCount: scores.length
        };
    }).sort((a, b)=>b.averageScore - a.averageScore); // Sort by score (highest first)
    return result;
}
/**
 * Determine the appropriate time grouping based on the timeFrame
 */ function getTimeGrouping(timeFrame) {
    switch(timeFrame){
        case 'last7days':
        case 'last30days':
            return 'day';
        case 'last90days':
            return 'week';
        case 'last6months':
        case 'lastYear':
        case 'allTime':
        default:
            return 'month';
    }
}
/**
 * Calculate date ranges based on timeFrame
 */ function getDateRanges(timeFrame) {
    const now = new Date();
    let currentStartDate;
    let currentEndDate = now;
    let previousStartDate;
    let previousEndDate;
    let currentPeriodLabel;
    let previousPeriodLabel = null;
    switch(timeFrame){
        case 'last7days':
            currentStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(now, 7);
            previousStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(currentStartDate, 7);
            previousEndDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(now, 8);
            currentPeriodLabel = 'Last 7 Days';
            previousPeriodLabel = 'Previous 7 Days';
            break;
        case 'last30days':
            currentStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(now, 30);
            previousStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(currentStartDate, 30);
            previousEndDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(now, 31);
            currentPeriodLabel = 'Last 30 Days';
            previousPeriodLabel = 'Previous 30 Days';
            break;
        case 'last90days':
            currentStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(now, 90);
            previousStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(currentStartDate, 90);
            previousEndDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(now, 91);
            currentPeriodLabel = 'Last 3 Months';
            previousPeriodLabel = 'Previous 3 Months';
            break;
        case 'last6months':
            currentStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subMonths$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subMonths"])(now, 6);
            previousStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subMonths$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subMonths"])(currentStartDate, 6);
            previousEndDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(currentStartDate, 1);
            currentPeriodLabel = 'Last 6 Months';
            previousPeriodLabel = 'Previous 6 Months';
            break;
        case 'lastYear':
            currentStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subMonths$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subMonths"])(now, 12);
            previousStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subMonths$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subMonths"])(currentStartDate, 12);
            previousEndDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(currentStartDate, 1);
            currentPeriodLabel = 'Last Year';
            previousPeriodLabel = 'Previous Year';
            break;
        case 'allTime':
            currentStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subMonths$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subMonths"])(now, 24); // Show up to 2 years of data
            previousStartDate = new Date(0); // Use epoch time instead of null
            previousEndDate = new Date(0); // Use epoch time instead of null
            currentPeriodLabel = 'All Time';
            previousPeriodLabel = null;
            break;
        default:
            // Default to last 30 days
            currentStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(now, 30);
            previousStartDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(currentStartDate, 30);
            previousEndDate = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2f$subDays$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["subDays"])(currentStartDate, 1);
            currentPeriodLabel = 'Last 30 Days';
            previousPeriodLabel = 'Previous 30 Days';
    }
    return {
        currentStartDate,
        currentEndDate,
        previousStartDate,
        previousEndDate,
        currentPeriodLabel,
        previousPeriodLabel
    };
}
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__e1fdb1e6._.js.map
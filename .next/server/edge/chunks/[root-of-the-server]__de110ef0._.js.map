{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 23, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { getToken } from \"next-auth/jwt\";\r\nimport { ROLES } from \"@/lib/constants\";\r\n\r\n// Maximum inactivity time (in seconds) - 1 hour\r\nconst MAX_INACTIVITY_TIME = 60 * 60;\r\n\r\n// Protected routes\r\nconst protectedRoutes = ['/dashboard', '/quiz', '/class', '/admin'];\r\nconst roleSelectPath = '/auth/select-role';\r\nconst authRoutes = ['/auth/signin', '/auth/signup', '/auth/error', roleSelectPath];\r\n\r\n// Session related API endpoints\r\nconst SESSION_API_ENDPOINTS = [\r\n  '/api/auth/session', \r\n  '/api/auth/signin', \r\n  '/api/auth/signout',\r\n  '/api/auth/callback',\r\n  '/api/auth/csrf'\r\n];\r\n\r\n// Prevent infinite redirects with a request counter\r\nconst MAX_REDIRECTS = 2;\r\n\r\n// Cache check results to avoid repeated checks\r\nconst cacheMap = new Map();\r\n\r\nexport async function middleware(req: NextRequest) {\r\n  const { pathname } = req.nextUrl;\r\n  \r\n  // PREVENT LOOPS - Immediately check protection cookies\r\n  // NextRequest.cookies is a synchronous API, different from next/headers cookies()\r\n  const redirectProtection = req.cookies.get('redirect-protection')?.value;\r\n  const roleSelected = req.cookies.get('role-selected')?.value;\r\n  \r\n  // Allow access to all API endpoints with minimal middleware processing\r\n  if (pathname.startsWith('/api/')) {\r\n    // Specific handling for auth API endpoints\r\n    if (SESSION_API_ENDPOINTS.some(endpoint => pathname.startsWith(endpoint))) {\r\n      // Skip all checks for auth endpoints\r\n      return NextResponse.next();\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n  \r\n  // Skip middleware for static files and images\r\n  if (pathname.startsWith('/_next/') || \r\n      pathname.includes('.')) {\r\n    return NextResponse.next();\r\n  }\r\n  \r\n  // SPECIAL RULE: If role-selected cookie exists, allow dashboard access even without a role\r\n  if (roleSelected && pathname.startsWith('/dashboard')) {\r\n    return NextResponse.next();\r\n  }\r\n  \r\n  // SPECIAL RULE: Allow access to select-role, no token check needed\r\n  if (pathname === roleSelectPath) {\r\n    return NextResponse.next();\r\n  }\r\n  \r\n  // Check protection cookie - if it exists, temporarily let the request through\r\n  if (redirectProtection && pathname !== '/api/auth/session') {\r\n    return NextResponse.next();\r\n  }\r\n  \r\n  try {\r\n    // Get token from NextAuth\r\n    const token = await getToken({ \r\n      req, \r\n      secret: process.env.NEXTAUTH_SECRET\r\n    });\r\n    \r\n    // If not logged in and accessing protected route: redirect to login\r\n    if (!token && protectedRoutes.some(route => pathname.startsWith(route))) {\r\n      const url = new URL('/auth/signin', req.url);\r\n      url.searchParams.set('callbackUrl', pathname);\r\n      return NextResponse.redirect(url);\r\n    }\r\n    \r\n    // If logged in without role, redirect to select-role\r\n    // But only when there's no protection cookie\r\n    if (token && token.role === null && !roleSelected) {\r\n      // Only redirect if not already on the select-role page\r\n      if (pathname !== roleSelectPath) {\r\n        // Create protection token to prevent loops\r\n        const response = NextResponse.redirect(new URL(roleSelectPath, req.url));\r\n        // NextResponse.cookies.set is a synchronous API\r\n        response.cookies.set('redirect-protection', 'true', {\r\n          httpOnly: true,\r\n          maxAge: 10, // Just 10 seconds, enough for the redirect\r\n          path: '/',\r\n        });\r\n        return response;\r\n      }\r\n    }\r\n    \r\n    // If logged in with role, redirect away from auth pages\r\n    if (token && token.role && authRoutes.includes(pathname)) {\r\n      return NextResponse.redirect(new URL('/dashboard', req.url));\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[Middleware Error]\", error);\r\n    // Fail open - allow request to continue even if session check fails\r\n    // This prevents site from being unusable if session API has issues\r\n    return NextResponse.next();\r\n  }\r\n  \r\n  // Nếu là API route liên quan đến quizzes, thêm log\r\n  if (pathname.startsWith('/api/users/me/quizzes')) {\r\n    console.log(`[API Request] ${req.method} ${pathname}${req.nextUrl.search}`);\r\n  }\r\n  \r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: ['/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'],\r\n}; "],"names":[],"mappings":"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"}}]
}